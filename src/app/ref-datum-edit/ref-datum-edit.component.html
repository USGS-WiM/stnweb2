<h2 mat-dialog-title *ngIf="editOrCreate === 'Edit'">
    Edit Reference Datum
    <button class="close-button" mat-button [mat-dialog-close]="{result: returnData}" aria-label="Exit"><mat-icon>close</mat-icon></button>
</h2>
<h2 mat-dialog-title *ngIf="editOrCreate === 'Create'">
    Create Reference Datum
    <button class="close-button" mat-button [mat-dialog-close]="{result: returnData}" aria-label="Exit"><mat-icon>close</mat-icon></button>
</h2>
<div [hidden]="!loading" class="loading">
    <mat-spinner style="margin:0 auto; top: 50%" mode="indeterminate" diameter="20"></mat-spinner>
</div>
<form [formGroup]="form" (ngSubmit)="submit()">
    <mat-dialog-content>
        <mat-accordion multi="true">
            <mat-expansion-panel hideToggle [expanded]="infoExpanded" (opened)="infoExpanded = true" (closed)="infoExpanded = false">
                <mat-expansion-panel-header>
                    <mat-panel-title *ngIf="!infoExpanded" style="color: grey; font-weight: 500">
                        Reference Datum Information
                    </mat-panel-title>
                    <mat-panel-title *ngIf="infoExpanded" style="color: #FFF; font-weight: 550">
                        Reference Datum Information
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <mat-form-field appearance="fill">
                    <mat-label>Type</mat-label>
                    <mat-select required aria-label="Type" formControlName="op_type_id">
                        <mat-option *ngFor="let type of types" [value]="type.objective_point_type_id">
                        {{type.op_type}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Name</mat-label>
                    <input aria-label="Name" matInput formControlName="name" required [value]="rd.name"/>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label for="description">Description</mat-label>
                    <textarea aria-label="description" matInput formControlName="description" required id="description" [value]="rd.description"></textarea>
                    <mat-icon matSuffix class="info-icon" matTooltip="Please describe location and type of mark ie. chiseled square on third sidewalk block on the south side of the street." 
                        aria-label="Displays a tooltip when focused or hovered over">info</mat-icon>
                </mat-form-field>
                <div>
                    <label class="form-header">Control Identifier</label>
                </div>
                <button type="button" class="ctrl-btn add" mat-stroked-button aria-label="Control Identifier" (click)="addControl()"><mat-icon>add</mat-icon> Add New Identifier</button>
                <mat-icon matSuffix class="info-icon" matTooltip="National Geodetic Survey permanent identifier. See: ngs.noaa.gov/NGSDataExplorer/ for more information.">info</mat-icon>
                <div class="inline-fields" *ngFor="let control of controlsToAdd; let i = index" formArrayName="op_control_identifier">
                    <button type="button" mat-button aria-label="Remove Control Identifier" (click)="removeControlIdentifier(control, i)"><mat-icon>close</mat-icon></button>
                    <div [formGroupName]="i" class="inline-widths">
                        <mat-form-field appearance="fill">
                            <mat-label>Control Identifier</mat-label>
                            <input aria-label="Control Identifier" matInput formControlName="identifier" [value]="control.identifier" (change)="addControlToList(i)"/>
                        </mat-form-field>
                    </div>
                    <mat-radio-group class="radio-btn-group" [(ngModel)]="controlsToAdd[i].identifier_type" [ngModelOptions]="{standalone: true}" (change)="changeControlID($event, i, control)">
                        <mat-radio-button class="radio-button" value="PID">PID</mat-radio-button>
                        <mat-radio-button class="radio-button" value="Other">Other</mat-radio-button>
                    </mat-radio-group>
                </div>
                <div>
                    <mat-label class="form-header">Lat/Lng Unit:</mat-label>
                    <mat-radio-group class="radio-btn-group" [(ngModel)]="latLngUnit" [ngModelOptions]="{standalone: true}" (change)="changeLatLngUnit($event)">
                        <mat-radio-button class="radio-button" value="decdeg">Dec Deg</mat-radio-button>
                        <mat-radio-button class="radio-button" value="dms">DMS</mat-radio-button>
                    </mat-radio-group>   
                </div>
                <div *ngIf="latLngUnit === 'decdeg'">            
                    <mat-form-field appearance="fill">
                        <mat-label>Latitude</mat-label>
                        <input aria-label="Latitude" matInput formControlName="latitude_dd" [value]="rd.latitude_dd"/>
                    </mat-form-field>
                    <!-- LatDD Validator -->
                    <div *ngIf="form.controls.latitude_dd.invalid && (form.controls.latitude_dd.dirty || form.controls.latitude_dd.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.latitude_dd.errors?.['incorrectValue']">
                            The latitude must be between 0 and 73.0.
                        </div>
                    </div>
                    <mat-form-field appearance="fill">
                        <mat-label>Longitude</mat-label>
                        <input aria-label="longitude" matInput formControlName="longitude_dd" [value]="rd.longitude_dd"/>
                    </mat-form-field>
                    <!-- LonDD Validator -->
                    <div *ngIf="form.controls.longitude_dd.invalid && (form.controls.longitude_dd.dirty || form.controls.longitude_dd.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.longitude_dd.errors?.['incorrectValue']">
                            The longitude must be between -175.0 and -60.0.
                        </div>
                    </div>
                </div>
                <div *ngIf="latLngUnit === 'dms'">
                    <table>
                        <tr>
                            <td>
                                <label>Latitude</label>
                            </td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Degree</mat-label>
                                    <input aria-label="Degree" required formControlName="latdeg" matInput [value]="dms.latdeg"/>
                                </mat-form-field>
                            </td>
                            <td>°</td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Minute</mat-label>
                                    <input aria-label="Minute" required formControlName="latmin" matInput [value]="dms.latmin"/>
                                </mat-form-field>
                            </td>
                            <td>′</td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Second</mat-label>
                                    <input aria-label="Second" required formControlName="latsec" matInput [value]="dms.latsec"/>
                                </mat-form-field>
                            </td>
                            <td>″</td>
                        </tr>
                    </table>
                    <!-- LatDD Validator -->
                    <div *ngIf="form.controls.latdeg.invalid && (form.controls.latdeg.dirty || form.controls.latdeg.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.latdeg.errors?.['incorrectValue']">
                            The latitude must be between -175.0 and -60.0.
                        </div>
                    </div>
                    <div *ngIf="form.controls.latmin.invalid && (form.controls.latmin.dirty || form.controls.latmin.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.latmin.errors?.['incorrectValue']">
                            The latitude must be between 0 and 73.
                        </div>
                    </div>
                    <div *ngIf="form.controls.latsec.invalid && (form.controls.latsec.dirty || form.controls.latsec.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.latsec.errors?.['incorrectValue']">
                            The latitude must be between 0 and 73.
                        </div>
                    </div>
                    <table>
                        <tr>
                            <td>
                                <label>Longitude</label>
                            </td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Degree</mat-label>
                                    <input aria-label="Degree" required formControlName="londeg" matInput [value]="dms.londeg"/>
                                </mat-form-field>
                            </td>
                            <td>°</td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Minute</mat-label>
                                    <input aria-label="Minute" required formControlName="lonmin" matInput [value]="dms.lonmin"/>
                                </mat-form-field>
                            </td>
                            <td>′</td>
                            <td>
                                <mat-form-field appearance="fill">
                                    <mat-label>Second</mat-label>
                                    <input aria-label="Second" required formControlName="lonsec" matInput [value]="dms.lonsec"/>
                                </mat-form-field>
                            </td>
                            <td>″</td>
                        </tr>
                    </table>
                    <!-- LonDD Validator -->
                    <div *ngIf="form.controls.londeg.invalid && (form.controls.londeg.dirty || form.controls.londeg.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.londeg.errors?.['incorrectValue']">
                            The longitude must be between -175.0 and -60.0.
                        </div>
                    </div>
                    <div *ngIf="form.controls.lonmin.invalid && (form.controls.lonmin.dirty || form.controls.lonmin.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.lonmin.errors?.['incorrectValue']">
                            The longitude must be between -175.0 and -60.0.
                        </div>
                    </div>
                    <div *ngIf="form.controls.lonsec.invalid && (form.controls.lonsec.dirty || form.controls.lonsec.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.lonsec.errors?.['incorrectValue']">
                            The longitude must be between -175.0 and -60.0.
                        </div>
                    </div>
                </div>
                <mat-form-field appearance="fill">
                    <mat-label>Horizontal Datum</mat-label>
                    <mat-select aria-label="Horizontal Datum" formControlName="hdatum_id">
                        <mat-option *ngFor="let datum of hdatums" [value]="datum.datum_id">
                        {{datum.datum_name}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Horizontal Collection Method</mat-label>
                    <mat-select aria-label="Horizontal Collection Method" formControlName="hcollect_method_id">
                        <mat-option *ngFor="let method of hmethods" [value]="method.hcollect_method_id">
                        {{method.hcollect_method}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <div class="inline-fields">
                    <mat-form-field class="inline-widths-80" appearance="fill">
                        <mat-label for="elevation">Elevation</mat-label>
                        <input aria-label="Elevation" matInput formControlName="elev_ft" [value]="rd.elev_ft"/>
                    </mat-form-field>
                    <mat-radio-group class="radio-btn-group" [(value)]="elev_unit" (change)="elevUnitChange($event)">
                        <mat-radio-button class="radio-button" value="ft">ft</mat-radio-button>
                        <mat-radio-button class="radio-button" value="m">meter</mat-radio-button>
                    </mat-radio-group>
                </div>
                <!-- Elevation Validator -->
                <div *ngIf="form.controls.elev_ft.invalid && (form.controls.elev_ft.dirty || form.controls.elev_ft.touched)"
                    class="alert alert-danger">
                    <div *ngIf="form.controls.elev_ft.errors?.['incorrectValue']">
                        Elevation must be a numeric value.
                    </div>
                </div>
                <mat-form-field appearance="fill">
                    <mat-label>Vertical Datum</mat-label>
                    <mat-select aria-label="Vertical Datum" required formControlName="vdatum_id">
                        <mat-option *ngFor="let datum of vdatums" [value]="datum.datum_id">
                        {{datum.datum_name}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Vertical Collection Method</mat-label>
                    <mat-select aria-label="Vertical Collection Method" formControlName="vcollect_method_id" [(value)]="rd.vcollect_method_id">
                        <mat-option *ngFor="let method of vmethods" [value]="method.vcollect_method_id">
                        {{method.vcollect_method}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <label class="form-header">Uncertainty</label>
                <div class="container">
                    <div class="inline-fields">
                        <mat-form-field id="uncertainty" class="inline-widths" appearance="fill">
                            <mat-label for="uncertainty">Uncertainty</mat-label>
                            <input aria-label="Uncertainty" matInput formControlName="uncertainty" [value]="rd.uncertainty"/>
                            <mat-icon matSuffix class="info-icon" matTooltip="From GNSS or OPUS solution.">info</mat-icon>
                        </mat-form-field>
                        <mat-radio-group class="radio-btn-group" [(value)]="uncertainty_unit" (change)="uncertaintyUnitChange($event)">
                            <mat-radio-button class="radio-button" value="ft">ft</mat-radio-button>
                            <mat-radio-button class="radio-button" value="cm">cm</mat-radio-button>
                        </mat-radio-group>
                        <mat-checkbox id="unquantified" [value]="unquantified" [checked]="unquantified" (change)="unquantifiedChanged($event)">
                            Unquantified
                        </mat-checkbox>
                    </div>                    <!-- Uncertainty Validator -->
                    <div *ngIf="form.controls.uncertainty.invalid && (form.controls.uncertainty.dirty || form.controls.uncertainty.touched)"
                        class="alert alert-danger">
                        <div *ngIf="form.controls.uncertainty.errors?.['incorrectValue']">
                            Uncertainty must be a numeric value.
                        </div>
                    </div>
                </div>
                <mat-form-field appearance="fill">
                    <mat-label>Quality</mat-label>
                    <mat-select aria-label="Quality" formControlName="op_quality_id" [(value)]="rd.op_quality_id">
                        <mat-option *ngFor="let quality of opQualities" [value]="quality.op_quality_id">
                        {{quality.quality}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Reference Datum Notes</mat-label>
                    <textarea aria-label="Reference Datum Notes" matInput formControlName="op_notes" [value]="rd.op_notes"></textarea>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Date Established</mat-label>
                    <input aria-label="Date Established" matInput formControlName="date_established" [value]="rd.date_established" [matDatepicker]="estDatePicker" required placeholder="Choose a date">
                    <mat-datepicker-toggle matSuffix [for]="estDatePicker"></mat-datepicker-toggle>
                    <mat-datepicker [value]="rd.date_established" #estDatePicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Date Last Checked</mat-label>
                    <input aria-label="Date Last Checked" matInput formControlName="date_recovered" [value]="rd.date_recovered" [matDatepicker]="recDatePicker" placeholder="Choose a date">
                    <mat-datepicker-toggle matSuffix [for]="recDatePicker"></mat-datepicker-toggle>
                    <mat-datepicker [value]="rd.date_recovered" #recDatePicker></mat-datepicker>
                    <mat-icon matSuffix class="info-icon" matTooltip="Enter the date the location was recently found in good condition.">info</mat-icon>
                </mat-form-field>
            </mat-expansion-panel>
            <mat-expansion-panel hideToggle [expanded]="filesExpanded" (opened)="filesExpanded = true" (closed)="filesExpanded = false">
                <mat-expansion-panel-header>
                    <mat-panel-title *ngIf="!filesExpanded" style="color: grey; font-weight: 500">
                        Reference Datum File Information
                    </mat-panel-title>
                    <mat-panel-title *ngIf="filesExpanded" style="color: #FFF; font-weight: 550">
                        Reference Datum File Information
                    </mat-panel-title>
                    <mat-panel-description>
                        <mat-icon class="info-header-icon" matTooltip="Files uploaded to Reference Datum are not tied to an event.  To associate a file with an event, please upload through a sensor or hwm instead of here.">info</mat-icon>
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <button mat-stroked-button (click)="showFileCreate()" class="add" type="button"
                    aria-label="Add File"><mat-icon>add</mat-icon> Add File
                </button>
                <!-- Create Reference Datum File Form -->
                <form *ngIf="showFileCreateForm" [formGroup]="rdFileForm">
                    <mat-form-field appearance="fill">
                        <mat-label>File Type</mat-label>
                        <mat-select aria-label="File Type" formControlName="filetype_id" (selectionChange)="getFileTypeSelection($event)">
                            <mat-option *ngFor="let file of fileTypes" [value]="file.filetype_id">
                                {{file.filetype}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!--Upload Single Image with validations*-->
                    <div *ngIf="addFileType === 'New' && selectedFile.FileEntity.filetype_id !== 8">
                        <label class="custom-file-input-add" for="addFile">
                            <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                        </label>
                        <input #upload id="addFile" class="upload-file" type="file" max="500000" [hidden]="true" (change)="getFileName($event)">
                    </div>
                    <br clear="all" />

                    <!--File URL (LINK file)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 8">
                        <mat-form-field appearance="fill">
                            <mat-label>File URL</mat-label>
                            <input aria-label="File URL" formControlName="name" matInput [value]="selectedFile.FileEntity.name"/>
                            <mat-icon matSuffix class="info-icon" matTooltip="Please link to persistent URLs or digital object identifier (doi) urls." 
                            aria-label="Displays a tooltip when focused or hovered over">info</mat-icon>                
                        </mat-form-field>
                    </div>

                    <!--Source Name (photo)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <mat-form-field appearance="fill">
                            <mat-label>Source Photographer</mat-label>
                            <input aria-label="Source Photographer" formControlName="FULLname" matInput required [value]="selectedFile.FileEntity.FULLname"/>           
                        </mat-form-field>
                    </div>

                    <!--Source Name (all other)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id  > 2">
                        <mat-form-field appearance="fill">
                            <mat-label>Source Name</mat-label>
                            <input aria-label="Source Name" formControlName="FULLname" matInput required [value]="selectedFile.FileEntity.FULLname"/>           
                        </mat-form-field>
                    </div>

                    <!--Source Agency* (photo, allOther)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1 || selectedFile.FileEntity.filetype_id > 2">
                        <mat-form-field appearance="fill">
                            <mat-label>Source Agency</mat-label>
                            <mat-select aria-label="Source Agency" required formControlName="agency_id" (selectionChange)="updateAgencyForCaption()">
                                <mat-option *ngFor="let a of agencies" [value]="a.agency_id">
                                    {{a.agency_name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <!-- Photo Date* (photo) -->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <mat-form-field appearance="fill">
                            <mat-label>Photo Date</mat-label>
                            <input aria-label="Photo Date" matInput formControlName="photo_date" [value]="selectedFile.FileEntity.photo_date" [matDatepicker]="photoDatePicker" required placeholder="Choose a date">
                            <mat-datepicker-toggle matSuffix [for]="photoDatePicker"></mat-datepicker-toggle>
                            <mat-datepicker [value]="selectedFile.FileEntity.photo_date" #photoDatePicker></mat-datepicker>
                        </mat-form-field>
                    </div>

                    <!-- Date Uploaded* (photo, data, allother) -->
                    <div *ngIf="selectedFile.FileEntity.filetype_id > 0">
                        <mat-form-field appearance="fill">
                            <mat-label>Date Uploaded</mat-label>
                            <input aria-label="Date Uploaded" matInput formControlName="file_date" [value]="selectedFile.FileEntity.file_date" [matDatepicker]="fileDatePicker" required placeholder="Choose a date">
                            <mat-datepicker-toggle matSuffix [for]="fileDatePicker"></mat-datepicker-toggle>
                            <mat-datepicker #fileDatePicker></mat-datepicker>
                        </mat-form-field>
                    </div>

                    <!--Description*(photo, data, allother)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id > 0">
                        <mat-form-field appearance="fill">
                            <mat-label for="description">Description</mat-label>
                            <textarea aria-label="Description" matInput formControlName="description" required id="description" [value]="selectedFile.FileEntity.description"></textarea>
                            <mat-icon [hidden]="selectedFile.FileEntity.filetype_id !== 1" matSuffix class="info-icon" matTooltip="Populates in Photo caption below. If a person or people appear in photo include name(s). If non-USGS personnel, ensure consent to publish name in caption is given." 
                            aria-label="Displays a tooltip when focused or hovered over">info</mat-icon>
                        </mat-form-field>
                    </div>

                    <!-- This is where Other ends, rest is for Photo -->
                    <!--Photo Direction (photo)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <mat-form-field appearance="fill">
                            <mat-label>Photo Direction</mat-label>
                            <input aria-label="Photo Direction" formControlName="photo_direction" matInput [value]="selectedFile.FileEntity.photo_direction"/>           
                        </mat-form-field>
                    </div>

                    <!-- Photo Latitude (photo)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <mat-form-field appearance="fill">
                            <mat-label>Photo Latitude (if different)</mat-label>
                            <input aria-label="Photo Latitude (if different)" formControlName="latitude_dd" matInput [value]="selectedFile.FileEntity.latitude_dd"/>           
                        </mat-form-field>
                    </div>
                    <!-- LatDD Validator -->
                    <div *ngIf="rdFileForm.controls.latitude_dd.invalid && (rdFileForm.controls.latitude_dd.dirty || rdFileForm.controls.latitude_dd.touched)"
                        class="alert alert-danger">
                        <div *ngIf="rdFileForm.controls.latitude_dd.errors?.['incorrectValue']">
                            The latitude must be between 0 and 73.0.
                        </div>
                    </div>

                    <!--Photo Longitude (photo)-->
                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <mat-form-field appearance="fill">
                            <mat-label>Photo Longitude (if different)</mat-label>
                            <input aria-label="Photo longitude (if different)" formControlName="longitude_dd" matInput [value]="selectedFile.FileEntity.longitude_dd"/>           
                        </mat-form-field>
                    </div>
                    <!-- LonDD Validator -->
                    <div *ngIf="rdFileForm.controls.longitude_dd.invalid && (rdFileForm.controls.longitude_dd.dirty || rdFileForm.controls.longitude_dd.touched)"
                        class="alert alert-danger">
                        <div *ngIf="rdFileForm.controls.longitude_dd.errors?.['incorrectValue']">
                            The longitude must be between -175.0 and -60.0.
                        </div>
                    </div>

                    <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                        <label class="form-header" for="Caption">Preview Caption</label>
                        <div>
                            <span>
                                Photo of {{rdFileForm.value.description || ' (Description HERE) '}} at {{data.rdSite.site_description}}, {{data.rdSite.county}}, {{data.rdSite.state}}, {{rdFileForm.value.photo_date | date: 'MM/dd/yyyy' || ' Date taken HERE '}}. Photograph by {{rdFileForm.value.FULLname || ' Source Name HERE ' }}, {{agencyNameForCap || ' Agency HERE '}}.
                            </span>
                        </div>
                    </div>

                    <!-- associated files -->
                    <div *ngIf="addFileType === 'Existing' && selectedFile.FileEntity.filetype_id !== 8">
                        <label class="form-header">Associated File:</label>
                        <div>
                            <span *ngIf="fileItemExists">
                                <a target="_blank" title="Download File" href="{{fileSource}}">{{selectedFile.FileEntity.name}}</a>
                            </span>
                            <span *ngIf="!fileItemExists">-- Missing --</span>
                            <!--ReUpload Single Image with validations*-->
                            <div *ngIf="!fileItemExists">
                                <label class="custom-file-input" for="Upload">
                                    <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                                </label>
                                <input #upload [hidden]="true" id="Upload" type="file" max="500000" file-model="existingFile.File" (change)="getFileName($event)">
                                <span *ngIf="fileUploading" class="file-upload-span">
                                    Correct File?
                                    <button aria-label="Upload" mat-button class="primary" *ngIf="fileUploading" type="button" (click)="saveFileUpload()">Upload</button>
                                </span>
                            </div>
                            <!-- change out the existing fileItem with a different one-->
                            <div *ngIf="fileItemExists">
                                <div>
                                    <label class="custom-file-inputChange" for="Upload">
                                        <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                                    </label>
                                    <input #upload [hidden]="true" id="Upload" type="file" max="500000" file-model="existingFile.File1" (change)="getFileName($event)">
                                </div>
                                <span *ngIf="fileUploading" class="file-upload-span">
                                    Correct File?
                                    <button aria-label="Is this file correct?" mat-button class="primary" *ngIf="fileUploading" type="button" (click)="saveFileUpload()">Upload</button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div [hidden]="siteFileIsUploading" class="file-button-group">
                        <button aria-label="Save File" mat-button type="button" class="save-btn primary" *ngIf="selectedFile.FileEntity.file_id !== null" (click)="saveFile()">Save File</button>
                        <button aria-label="Create File" mat-button type="button" class="save-btn primary" *ngIf="selectedFile.FileEntity.file_id == null" (click)="createFile()">Create File</button>
                        <button aria-label="Close or Cancel File" mat-stroked-button class="secondary" style="margin-left: 10px" type="button" (click)="cancelFile()">Close/Cancel File</button>
                    </div>
                </form>
                <div class="tableContainer" [hidden]="initDatumFiles?.length === 0">
                    <table
                        mat-table
                        id="datumFileTable"
                        [dataSource]="initDatumFiles"
                        class="mat-elevation-z5"
                        matSort
                        multiTemplateDataRows
                    >

                        <!-- file name column -->
                        <ng-container matColumnDef="FileName">
                            <th mat-header-cell *matHeaderCellDef>File Name</th>
                            <td mat-cell *matCellDef="let file">
                                <div>
                                    {{file.name}}
                                </div>
                            </td>
                        </ng-container>

                        <!-- file date column -->
                        <ng-container matColumnDef="FileDate">
                            <th mat-header-cell *matHeaderCellDef>File Date</th>
                            <td mat-cell *matCellDef="let file">
                                <div>
                                    {{file.file_date | date: 'MM/dd/yyyy'}}
                                </div>
                            </td>
                        </ng-container>

                        <!-- button column -->
                        <ng-container matColumnDef="expand">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let element">
                                <button mat-stroked-button *ngIf="showFileForm || expandedElement != element" class="view-details-btn secondary" type="button" (click)="showFileDetails(element)"
                                    aria-label="View Details">View Details
                                </button>
                                <button mat-stroked-button *ngIf="!showFileForm && expandedElement == element" class="view-details-btn secondary" type="button" (click)="showFileDetails(null)"
                                    aria-label="Close Details">Close Details
                                </button>
                                <button *ngIf="showDetails || expandedElement != element" mat-stroked-button class="edit-details-btn secondary" type="button" (click)="showFileEdit(element)"
                                    aria-label="Edit"><mat-icon class="edit-icon">edit</mat-icon>Edit
                                </button>
                                <button *ngIf="!showDetails && expandedElement == element" mat-stroked-button class="edit-details-btn secondary" type="button" (click)="showFileEdit(null)"
                                    aria-label="Edit"><mat-icon class="edit-icon">edit</mat-icon>Close Edit
                                </button>
                                <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Icon-button with a menu" type="button">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #menu="matMenu">
                                    <button mat-menu-item *ngIf="showFileForm || expandedElement != element" class="view-details-mobile" type="button" (click)="showFileDetails(element)"
                                        aria-label="View Details"><mat-icon>search</mat-icon>
                                        <span> View Details</span>
                                    </button>
                                    <button mat-menu-item *ngIf="!showFileForm && expandedElement == element" class="view-details-mobile" type="button" (click)="showFileDetails(null)"
                                        aria-label="Close Details"><mat-icon>search</mat-icon>
                                        <span> Close Details</span>
                                    </button>
                                    <button *ngIf="showDetails || expandedElement != element" mat-menu-item class="edit-details-mobile" type="button" (click)="showFileEdit(element)"
                                        aria-label="Edit"><mat-icon class="edit-icon">edit</mat-icon>Edit
                                    </button>
                                    <button *ngIf="!showDetails && expandedElement == element" mat-menu-item class="edit-details-mobile" type="button" (click)="showFileEdit(null)"
                                        aria-label="Edit"><mat-icon class="edit-icon">edit</mat-icon>Close Edit
                                    </button>
                                    <button mat-menu-item class="delete-borderless" type="button" (click)="deleteFile(element)"
                                        aria-label="Delete"><mat-icon class="delete-borderless">delete_forever</mat-icon>
                                        <span>Delete</span>
                                    </button>
                                </mat-menu>
                            </td>
                        </ng-container>

                        <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
                        <ng-container matColumnDef="expandedDetail">
                            <td mat-cell *matCellDef="let element" [attr.colspan]="3">
                                <div class="element-detail"
                                    [@detailExpand]="showFileForm && expandedElement == element ? 'expanded' : 'collapsed'">
                                    <div class="expanded-body">
                                        <!-- Edit Reference Datum File Form -->
                                        <form [formGroup]="rdFileForm">
                                            <mat-form-field appearance="fill">
                                                <mat-label>File Type</mat-label>
                                                <mat-select aria-label="File Type" formControlName="filetype_id" (selectionChange)="getFileTypeSelection($event)">
                                                    <mat-option *ngFor="let file of fileTypes" [value]="file.filetype_id">
                                                        {{file.filetype}}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                            <!--Upload Single Image with validations*-->
                                            <div *ngIf="addFileType === 'New' && selectedFile.FileEntity.filetype_id !== 8">
                                                <label class="custom-file-input-add" for="addFile">
                                                    <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                                                </label>
                                                <input #upload id="addFile" class="upload-file" type="file" max="500000" [hidden]="true" (change)="getFileName($event)">
                                            </div>
                                            <br clear="all" />

                                            <!--File URL (LINK file)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 8">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>File URL</mat-label>
                                                    <input aria-label="File URL" formControlName="name" matInput [value]="selectedFile.FileEntity.name"/>
                                                    <mat-icon matSuffix class="info-icon" matTooltip="Please link to persistent URLs or digital object identifier (doi) urls." 
                                                    aria-label="Displays a tooltip when focused or hovered over">info</mat-icon>                
                                                </mat-form-field>
                                            </div>

                                            <!--Source Name (photo)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Source Photographer</mat-label>
                                                    <input aria-label="Source Photographer" formControlName="FULLname" matInput required [value]="selectedFile.FileEntity.FULLname"/>           
                                                </mat-form-field>
                                            </div>

                                            <!--Source Name (all other)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id  > 2">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Source Name</mat-label>
                                                    <input aria-label="Source Name" formControlName="FULLname" matInput required [value]="selectedFile.FileEntity.FULLname"/>           
                                                </mat-form-field>
                                            </div>

                                            <!--Source Agency* (photo, allOther)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1 || selectedFile.FileEntity.filetype_id > 2">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Source Agency</mat-label>
                                                    <mat-select aria-label="Source Agency" required formControlName="agency_id" (selectionChange)="updateAgencyForCaption()">
                                                        <mat-option *ngFor="let a of agencies" [value]="a.agency_id">
                                                            {{a.agency_name}}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>

                                            <!-- Photo Date* (photo) -->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Photo Date</mat-label>
                                                    <input aria-label="Photo Date" matInput formControlName="photo_date" [value]="selectedFile.FileEntity.photo_date" [matDatepicker]="photoDatePicker" required placeholder="Choose a date">
                                                    <mat-datepicker-toggle matSuffix [for]="photoDatePicker"></mat-datepicker-toggle>
                                                    <mat-datepicker [value]="selectedFile.FileEntity.photo_date" #photoDatePicker></mat-datepicker>
                                                </mat-form-field>
                                            </div>

                                            <!-- Date Uploaded* (photo, data, allother) -->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id > 0">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Date Uploaded</mat-label>
                                                    <input aria-label="Date Uploaded" matInput formControlName="file_date" [value]="selectedFile.FileEntity.file_date" [matDatepicker]="fileDatePicker" required placeholder="Choose a date">
                                                    <mat-datepicker-toggle matSuffix [for]="fileDatePicker"></mat-datepicker-toggle>
                                                    <mat-datepicker #fileDatePicker></mat-datepicker>
                                                </mat-form-field>
                                            </div>

                                            <!--Description*(photo, data, allother)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id > 0">
                                                <mat-form-field appearance="fill">
                                                    <mat-label for="description">Description</mat-label>
                                                    <textarea aria-label="Description" matInput formControlName="description" required id="description" [value]="selectedFile.FileEntity.description"></textarea>
                                                    <mat-icon [hidden]="selectedFile.FileEntity.filetype_id !== 1" matSuffix class="info-icon" matTooltip="Populates in Photo caption below. If a person or people appear in photo include name(s). If non-USGS personnel, ensure consent to publish name in caption is given." 
                                                    aria-label="Displays a tooltip when focused or hovered over">info</mat-icon>
                                                </mat-form-field>
                                            </div>

                                            <!-- This is where Other ends, rest is for Photo -->
                                            <!--Photo Direction (photo)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Photo Direction</mat-label>
                                                    <input aria-label="Photo Direction" formControlName="photo_direction" matInput [value]="selectedFile.FileEntity.photo_direction"/>           
                                                </mat-form-field>
                                            </div>

                                            <!-- Photo Latitude (photo)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Photo Latitude (if different)</mat-label>
                                                    <input aria-label="Photo Latitude (if different)" formControlName="latitude_dd" matInput [value]="selectedFile.FileEntity.latitude_dd"/>           
                                                </mat-form-field>
                                            </div>
                                            <!-- LatDD Validator -->
                                            <div *ngIf="rdFileForm.controls.latitude_dd.invalid && (rdFileForm.controls.latitude_dd.dirty || rdFileForm.controls.latitude_dd.touched)"
                                                class="alert alert-danger">
                                                <div *ngIf="rdFileForm.controls.latitude_dd.errors?.['incorrectValue']">
                                                    The latitude must be between 0 and 73.0.
                                                </div>
                                            </div>

                                            <!--Photo Longitude (photo)-->
                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <mat-form-field appearance="fill">
                                                    <mat-label>Photo Longitude (if different)</mat-label>
                                                    <input aria-label="Photo longitude (if different)" formControlName="longitude_dd" matInput [value]="selectedFile.FileEntity.longitude_dd"/>           
                                                </mat-form-field>
                                            </div>
                                            <!-- LonDD Validator -->
                                            <div *ngIf="rdFileForm.controls.longitude_dd.invalid && (rdFileForm.controls.longitude_dd.dirty || rdFileForm.controls.longitude_dd.touched)"
                                                class="alert alert-danger">
                                                <div *ngIf="rdFileForm.controls.longitude_dd.errors?.['incorrectValue']">
                                                    The longitude must be between -175.0 and -60.0.
                                                </div>
                                            </div>

                                            <div *ngIf="selectedFile.FileEntity.filetype_id === 1">
                                                <label class="form-header" for="Caption">Preview Caption</label>
                                                <div>
                                                    <span>
                                                        Photo of {{rdFileForm.value.description || ' (Description HERE) '}} at {{data.rdSite.site_description}}, {{data.rdSite.county}}, {{data.rdSite.state}}, {{rdFileForm.value.photo_date | date: 'MM/dd/yyyy' || ' Date taken HERE '}}. Photograph by {{rdFileForm.value.FULLname || ' Source Name HERE ' }}, {{agencyNameForCap || ' Agency HERE '}}.
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- associated files -->
                                            <div *ngIf="addFileType === 'Existing' && selectedFile.FileEntity.filetype_id !== 8">
                                                <label class="form-header">Associated File:</label>
                                                <div>
                                                    <span *ngIf="fileItemExists">
                                                        <a target="_blank" title="Download File" href="{{fileSource}}">{{selectedFile.FileEntity.name}}</a>
                                                    </span>
                                                    <span *ngIf="!fileItemExists">-- Missing --</span>
                                                    <!--ReUpload Single Image with validations*-->
                                                    <div *ngIf="!fileItemExists">
                                                        <label class="custom-file-input" for="Upload">
                                                            <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                                                        </label>
                                                        <input #upload [hidden]="true" id="Upload" type="file" max="500000" file-model="existingFile.File" (change)="getFileName($event)">
                                                        <span *ngIf="fileUploading" class="file-upload-span">
                                                            Correct File?
                                                            <button aria-label="Upload" mat-button class="primary" *ngIf="fileUploading" type="button" (click)="saveFileUpload()">Upload</button>
                                                        </span>
                                                    </div>
                                                    <!-- change out the existing fileItem with a different one-->
                                                    <div *ngIf="fileItemExists">
                                                        <div>
                                                            <label class="custom-file-inputChange" for="Upload">
                                                                <p class="required">*</p> {{ selectedFile.FileEntity.name || ' None Chosen' }}
                                                            </label>
                                                            <input #upload [hidden]="true" id="Upload" type="file" max="500000" file-model="existingFile.File1" (change)="getFileName($event)">
                                                        </div>
                                                        <span *ngIf="fileUploading" class="file-upload-span">
                                                            Correct File?
                                                            <button aria-label="Is this file correct?" mat-button class="primary" *ngIf="fileUploading" type="button" (click)="saveFileUpload()">Upload</button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div [hidden]="siteFileIsUploading" class="file-button-group">
                                                <button aria-label="Save File" mat-button type="button" class="save-btn primary" *ngIf="selectedFile.FileEntity.file_id !== null" (click)="saveFile()">Save File</button>
                                                <button aria-label="Create File" mat-button type="button" class="save-btn primary" *ngIf="selectedFile.FileEntity.file_id == null" (click)="createFile()">Create File</button>
                                                <button aria-label="Close or Cancel File" mat-stroked-button class="secondary" style="margin-left: 10px" type="button" (click)="cancelFile()">Close/Cancel File</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="element-detail"
                                    [@detailExpand]="showDetails && expandedElement == element ? 'expanded' : 'collapsed'">
                                    <div class="expanded-body">
                                        <div class="table-container">
                                            <div class="outer-content">
                                                <div class="cell-container">
                                                    <p class="content-left">File Type</p>
                                                    <p class="content-right" *ngIf="fileType !== undefined && fileType !== ''; else nullFileType">{{fileType}}</p>
                                                    <ng-template #nullFileType><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="element.is_nwis !== undefined && element.is_nwis === 1">
                                                    <p class="content-left">File URL</p>
                                                    <p class="content-right" *ngIf="element.name !== undefined && element.name !== ''; else nullFileURL">{{element.name}}</p>
                                                    <ng-template #nullFileURL><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Source Photographer</p>
                                                    <p class="content-right" *ngIf="sourceName !== undefined && sourceName !== ''; else nullSourceName">{{sourceName}}</p>
                                                    <ng-template #nullSourceName><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType !== 'Photo' && fileType !== 'Data' && (element.is_nwis === undefined || element.is_nwis !== 1)">
                                                    <p class="content-left">Source Name</p>
                                                    <p class="content-right" *ngIf="sourceName !== undefined && sourceName !== ''; else nullSourceName">{{sourceName}}</p>
                                                    <ng-template #nullSourceName><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType !== 'Photo' && fileType !== 'Data' && (element.is_nwis === undefined || element.is_nwis !== 1)">
                                                    <p class="content-left">Source Agency</p>
                                                    <p class="content-right" *ngIf="sourceAgency !== undefined && sourceAgency !== ''; else nullSourceAgency">{{sourceAgency}}</p>
                                                    <ng-template #nullSourceAgency><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container"  *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Photo Date</p>
                                                    <p class="content-right" *ngIf="element.photo_date !== undefined && element.photo_date !== ''; else nullPhotoDate">{{element.photo_date | date: 'MM/dd/yyyy'}}</p>
                                                    <ng-template #nullPhotoDate><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container">
                                                    <p class="content-left">Date Uploaded</p>
                                                    <p class="content-right" *ngIf="element.file_date !== undefined && element.file_date !== ''; else nullFileDate">{{element.file_date | date: 'MM/dd/yyyy'}}</p>
                                                    <ng-template #nullFileDate><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container">
                                                    <p class="content-left">Description</p>
                                                    <p class="content-right" *ngIf="element.description !== undefined && element.description !== ''; else nullDesc">{{element.description}}</p>
                                                    <ng-template #nullDesc><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Photo Direction</p>
                                                    <p class="content-right" *ngIf="element.photo_direction !== undefined && element.photo_direction !== ''; else nullPhotoDir">{{element.photo_direction}}</p>
                                                    <ng-template #nullPhotoDir><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Photo Latitude (if different)</p>
                                                    <p class="content-right" *ngIf="element.latitude_dd !== undefined && element.latitude_dd !== ''; else nullPhotoLat">{{element.latitude_dd}}</p>
                                                    <ng-template #nullPhotoLat><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Photo Longitude (if different)</p>
                                                    <p class="content-right" *ngIf="element.longitude_dd !== undefined && element.longitude_dd !== ''; else nullPhotoLon">{{element.longitude_dd}}</p>
                                                    <ng-template #nullPhotoLon><p class="content-right">---</p></ng-template>
                                                </div>
                                                <div class="cell-container" *ngIf="fileType === 'Photo'">
                                                    <p class="content-left">Preview Caption</p>
                                                    <p class="content-right">Photo of {{previewCaption.description}} at {{previewCaption.site_description}}, {{previewCaption.county}}, {{previewCaption.state}}, {{previewCaption.photo_date | date: 'MM/dd/yyyy'}}.  Photograph by {{previewCaption.sourceName}}, {{previewCaption.sourceAgency}}</p>
                                                </div>
                                                <div class="cell-container" *ngIf="element.is_nwis === undefined || element.is_nwis !== 1">
                                                    <p class="content-left">Associated File</p>
                                                    <p class="content-right"><a id="associatedFile" href="{{fileSource}}" target="_blank">{{element.name}}</a></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedFileColumns"></tr>
                        <tr mat-row *matRowDef="let element; columns: displayedFileColumns;">
                        </tr>
                        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
                    </table>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
        <div class="detail-section-buttons centered">
            <div class="ref-button-group">
                <button *ngIf="editOrCreate === 'Edit'" class="primary save-btn" mat-button cdkFocusInitial aria-label="Save" type="submit">Save</button>
                <button *ngIf="editOrCreate === 'Create'" class="primary save-btn" mat-button cdkFocusInitial aria-label="Create" type="submit">Create</button>
                <button class="cancel-btn secondary" mat-stroked-button [mat-dialog-close]="{result: returnData}" cdkFocusInitial aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </mat-dialog-actions>
</form>


